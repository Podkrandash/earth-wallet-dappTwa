import{bo as w,bp as E,bq as M,r,b as g,aS as x,br as I,bs as q,bt as B,bu as N,bv as D,bw as O,bx as K,by as j,bz as P,bA as W,j as l,bB as k,bC as J}from"./index-Ikj8v-B_.js";const _=async({connection:e,request:{id:n,method:a}})=>{await w({response:M(n,a),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})},T=async({connection:e,request:{id:n}})=>{await w({response:E(n),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})},L=()=>J(_),S="TK_WEB::TON_CONNECT",z=()=>{var A;const[e,n]=r.useState(void 0),a=g(),R=x(),{data:t}=I(),{data:f}=q(),{mutateAsync:b}=B(),{mutate:y}=L(),{mutateAsync:p}=N();D((A=e==null?void 0:e.connection)==null?void 0:A.manifest);const{mutateAsync:h}=O();r.useEffect(()=>{const o=s=>{switch(s.request.method){case"disconnect":return b(s.connection).then(()=>T({...s}));case"sendTransaction":{n(void 0);const i={connection:s.connection,id:s.request.id,payload:JSON.parse(s.request.params[0])},d=t==null?void 0:t.find(v=>v.connections.some(C=>C.clientSessionId===s.connection.clientSessionId));d?h(d.wallet.rawAddress).then(()=>setTimeout(()=>{n(i)},100)):setTimeout(()=>{n(i)},100);return}default:return y(s)}},{notifications:c}=a;(async()=>{if(c&&t)try{if(await c.subscribed(R.rawAddress))for(const i of t.flatMap(d=>d.connections))await c.subscribeTonConnect(i.clientSessionId,new URL(i.manifest.url).host)}catch(s){s instanceof Error&&a.topMessage(s.message)}})();const u=K({storage:a.storage,handleMessage:o,connections:t==null?void 0:t.flatMap(s=>s.connections),lastEventId:f});return()=>{u()}},[a,t,f,b,n,y]);const m=r.useCallback(async o=>{if(e){try{await p({request:e,boc:o})}finally{n(void 0)}j(S,JSON.stringify({event:"close-tx-confirmation",id:e.id}))}},[e,p,n]);return r.useEffect(()=>{if(e)return P(S,o=>{const c=JSON.parse(o);c.id===e.id&&c.event==="close-tx-confirmation"&&n(void 0)})},[e]),r.useEffect(()=>W.subscribe(o=>{(Array.isArray(o)?o:[o]).forEach((u,s)=>T({connection:u,request:{id:(Date.now()+s).toString()}}))}),[]),l.jsx(l.Fragment,{children:l.jsx(k,{params:(e==null?void 0:e.payload)??null,handleClose:m})})};export{z as default};
